# This is a basic workflow to help you get started with Actions

name: CI-CD-Pipeline-to-AWS-ElasticBeastalk
env:
  EB_PACKEGE_S3_BUCKET_NAME: "bohdan-flask-application-packeges"  # AWS name packege
  EB_APPLICATIN_NAME: "MyFlask"
  EB_ENVIROMENT_NAME: "MyFlask-env"
  DEPLOY_PACKEGE_NAME: "flask_app_${{github.sha}}.zip"
  AWS_REGION_NAME: "eu-central-1"
  
  
# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main ]


  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  my-ci-part:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Git clone our repo
        uses: actions/checkout@v2

     
      - name: Create ZIP deployment packege
        run: zip -r ${{env.DEPLOY_PACKEGE_NAME}} ./ -x *.git* #запакувати все крім файлів з розширенням .git
        
      # Authentification with AWS user
      - name: Cnnfigure my AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with: 
            aws-access-key-id    : ${{secrets.MY_AWS_ACCESS_KEY}}
            aws-secret-access-key: ${{secrets.MY_AWS_SECRET_KEY}}
            aws-region           : ${{env.AWS_REGION_NAME}}
    
      - name: Copy Deployment packege to S3 Bucket
        run: aws s3 cp ${{ DEPLOY_PACKEGE_NAME }} s3://{{ env.EB_PACKEGE_S3_BUCKET_NAME }}/
        
      - name: Print Happy message for CI finish
        run: echo "CI pipeline is DONE!"
